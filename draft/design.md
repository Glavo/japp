# 设计方案（草稿）

目的：设计一个新的格式（`japp`），允许将一组模块化或者非模块化的 JAR 捆绑进同一个文件中，同时支持在该文件中描述对 Java 版本的需求，启动时能够自动选择正确的 Java 版本。

## 架构

本项目计划有如下几个子模块：

* `packer`: 打包器模块，用于生成 japp 文件（用 Java 实现）。
* `launcher`: 启动器模块，用于启动 japp 格式的程序（前期原型仅用 Java 实现，后期考虑提供一个由 Rust 重新实现的版本）。
* `bootlauncher`：引导模块，用于在 Java 程序中支持直接从 japp 文件中加载类（用 Java 实现）。

## 文件格式

具体格式设计中，这里是一些想法；

* 文件 magic number 和元数据放置在文件最后，这样我们可以默认在文件头部拼接这样一段 shell：
    
    ```bash
    #!/usr/bin/env japp
    ```
  
    我们可以使用该文件头让程序能够直接在 Unix-Like 的系统上以 `./myapp.japp` 的方式运行，而对于 Windows 则注册文件的打开方式，允许双击打开。
    文件头可以灵活更改，之后可以在其中实现更多逻辑，比如在发现用户没有安装 japp 启动器时给用户更详细的提示与引导。

* 我们应该使用类似 JImage 的方式，使用一个共享字符串池存储类名信息，加载时再通过 `bootlauncher` 重新复原类。
* 对于共享字符串池，我们可以运用某种压缩方法进行压缩处理。（也许可以采用 LZ4 或者 zstd，并使用 Java 标准库和常用类的名称生成一个预训练字典）

TODO

